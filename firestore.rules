rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - allow queries for login purposes and user management
    match /users/{userId} {
      // Allow read/write for own data
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow admins to read/write all user data
      allow read, write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Allow queries on userCode field for login purposes (unauthenticated)
      // This is needed for the getUserByCode function to work during login
      allow read: if resource.data.userCode != null;
    }
    
    // Defect records collection - authenticated users can read/write
    match /defectRecords/{recordId} {
      allow read, write: if request.auth != null;
    }
    
    // Archived dates collection - authenticated users can read/write
    match /archivedDates/{userEmail} {
      allow read, write: if request.auth != null;
    }
    
    // Internal notices collection - allow all authenticated users to read all notices
    // Filtering will be handled in the application code
    match /internalNotices/{noticeId} {
      // Allow all authenticated users to read all notices (filtering handled in app)
      allow read: if request.auth != null;
      
      // Allow all authenticated users to create notices
      allow create: if request.auth != null;
      
      // Allow users to update/delete their own notices, or admins to update/delete any notice
      allow update, delete: if request.auth != null && 
        (resource.data.author == request.auth.token.email ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Allow queries on internal notices collection for all authenticated users
    match /internalNotices {
      allow read: if request.auth != null;
    }
    
    // Aircraft collection - admin-only write access, all authenticated users can read
    match /aircraft/{aircraftId} {
      // Allow all authenticated users to read aircraft data
      allow read: if request.auth != null;
      
      // Only allow admins to write (create, update, delete) aircraft data
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Allow queries on aircraft collection for all authenticated users
    match /aircraft {
      allow read: if request.auth != null;
    }
  }
}
